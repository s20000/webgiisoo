(function(a){a.fn.fileuploader=function(f){f=a.extend({tag:"default",caption:"添加文件",autoretry:true,maxFileSize:1024*1024*1024*100,},f);function d(h){if(h<1024){return h;}h/=1024;if(h<1024){return parseInt(h*10)/10+"K";}h/=1024;if(h<1024){return parseInt(h*10)/10+"M";}h/=1024;return parseInt(h*10)/10+"G";}function c(){g&&g.submit();}var g=false;var e=a(this);var b=a("<div class='fileuploader'><div class='fileuploader-btns btns'><a href='javascript:;' class='fileuploader-btn'>"+f.caption+"</a><span class='fileuploader-file'></span></div><div class='fileuploader-state'><span class='fileuploader-filename'></span><span class='fileuploader-progress'><span class='fileuploader-bar-outter'><span class='fileuploader-bar'></span></span><span class='fileuploader-message'></span></span><a href='javascript:;' class='fileuploader-cancel'>取消</a></div></div>");e.before(b);b.find(".fileuploader-file").append(e);e=b.find(".fileuploader-file input");b.find(".fileuploader-btn").click(function(){e.trigger("click");f.autoretry=true;});b.find(".fileuploader-cancel").click(function(){f.autoretry=false;g&&g.abort();});e.fileupload({url:"/upload?tag="+f.tag,dataType:"json",autoUpload:true,maxFileSize:f.maxFileSize,limitConcurrentUploads:1,maxNumberOfFiles:1,sequentialUploads:true,progressInterval:100,maxChunkSize:16384,}).on("fileuploadadd",function(j,i){try{g=i;a(f.note).hide();b.find(".fileuploader-cancel").show();b.find(".fileuploader-state").show();b.find(".fileuploader-filename").text(i.files[0].name);}catch(h){console.log(h);}}).on("fileuploadprogressall",function(j,i){b.find(".fileuploader-message").text(i.loaded+"("+d(i.loaded)+"/"+d(i.total)+")");b.find(".fileuploader-message").removeClass("red");var h=parseInt(i.loaded/i.total*100,10);b.find(".fileuploader-bar").css("width",h+"%");}).on("fileuploadchunkfail",function(i,h){if(h.result){b.find(".fileuploader-message").text(h.result.error);}else{b.find(".fileuploader-message").text("停止");}b.find(".fileuploader-message").addClass("red");if(f.autoretry){setTimeout(c,1000);}}).on("fileuploadfail",function(i,h){b.find(".fileuploader-message").text("停止");b.find(".fileuploader-message").addClass("red");if(f.autoretry){setTimeout(c,1000);}}).on("fileuploaddone",function(i,h){b.find(".fileuploader-message").text("完成");b.find(".fileuploader-message").removeClass("red");b.find(".fileuploader-cancel").hide();g=false;if(f.done&&typeof(f.done)=="function"){if(h.result){f.done(h.result.url,h.result.repo);}else{f.done();}}}).prop("disabled",!a.support.fileInput).parent().addClass(a.support.fileInput?undefined:"disabled");};})(jQuery);